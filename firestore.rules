rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------------------------
    // HELPER FUNCTIONS
    // ---------------------------

    function isUserSignedIn() {
      return request.auth != null;
    }

    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isRootAdmin() {
      let userDoc = getUserDoc();
      return isUserSignedIn() &&
             userDoc.data != null &&
             'roles' in userDoc.data &&
             userDoc.data.roles.hasAny(['RootAdmin']);
    }

    function isChurchMember(churchId) {
      let userDoc = getUserDoc();
      return isUserSignedIn() &&
             userDoc.data != null &&
             'churchId' in userDoc.data &&
             userDoc.data.churchId == churchId;
    }

    function hasChurchRole(churchId, allowedRoles) {
      let userDoc = getUserDoc();
      return isChurchMember(churchId) &&
             userDoc.data != null &&
             'roles' in userDoc.data &&
             userDoc.data.roles.hasAny(allowedRoles);
    }

    function isAdmin() {
      let userDoc = getUserDoc();
      return isUserSignedIn() &&
             userDoc.data != null &&
             'roles' in userDoc.data &&
             userDoc.data.roles.hasAny(['Admin']);
    }

    // ---------------------------
    // USERS COLLECTION
    // ---------------------------
    match /users/{uid} {
      // User can read/write their own profile
      allow read, write: if request.auth != null && request.auth.uid == uid;

      // Root Admin full access
      allow read, write: if isRootAdmin();

      // Church Admins can read users in their own church
      allow read: if isUserSignedIn() &&
                  getUserDoc().data.churchId == resource.data.churchId &&
                  hasChurchRole(resource.data.churchId, ["Admin"]);
    }

    // ---------------------------
    // CHURCHES COLLECTION
    // ---------------------------
    match /churches/{churchId} {

      // CHURCH DOCUMENT ITSELF
      allow read: if isChurchMember(churchId);
      allow update: if hasChurchRole(churchId, ["Admin"]);

      // MEMBERS
      match /members/{memberId} {
        allow read: if isChurchMember(churchId);
        allow create, update, delete: if hasChurchRole(churchId, ["Admin", "MemberManager"]);
      }

      // EVENTS
      match /events/{eventId} {
        allow read: if isChurchMember(churchId);
        allow create, update, delete: if hasChurchRole(churchId, ["Admin", "EventManager"]);
      }

      // CONTRIBUTIONS
      match /contributions/{contributionId} {
        allow read: if isChurchMember(churchId);
        allow create, update, delete: if hasChurchRole(churchId, ["Admin", "Finance"]);
      }

      // SERVICE PLANS
      match /servicePlans/{planId} {
        allow read, write: if isChurchMember(churchId);
      }

      // SONGS
      match /songs/{songId} {
        allow read: if isChurchMember(churchId);
        allow create, update, delete: if hasChurchRole(churchId, ["Admin", "MusicManager"]);
      }

      // SET LISTS
      match /setlists/{setListId} {
        allow read: if isChurchMember(churchId);
        allow create, update, delete: if hasChurchRole(churchId, ["Admin", "MusicManager"]);
      }
    }

    // Allow Admins and Members to read any subcollection under their church
    match /{sub=**} {
      allow read: if isChurchMember(churchId);
      allow write: if hasChurchRole(churchId, ["Admin"]);
    }

    // ---------------------------
    // ROOT ADMIN FALLBACK ACCESS
    // ---------------------------
    match /{document=**} {
      allow read, write: if isRootAdmin();
    }
  }
}
