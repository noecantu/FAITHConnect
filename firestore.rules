rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------------------------
    // HELPER FUNCTIONS
    // ---------------------------

    function isUserSignedIn() {
      return request.auth != null;
    }

    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isChurchMember(churchId) {
      let userDoc = getUserDoc();
      return isUserSignedIn() &&
             userDoc.data != null &&
             'churchId' in userDoc.data &&
             userDoc.data.churchId == churchId;
    }

    function hasChurchRole(churchId, allowedRoles) {
      let userDoc = getUserDoc();
      return isChurchMember(churchId) &&
             userDoc.data != null &&
             'roles' in userDoc.data &&
             userDoc.data.roles.hasAny(allowedRoles);
    }

    function isAdmin() {
      let userDoc = getUserDoc();
      return isUserSignedIn() &&
             userDoc.data != null &&
             'roles' in userDoc.data &&
             userDoc.data.roles.hasAny(['Admin']);
    }

    // ---------------------------
    // USERS COLLECTION
    // ---------------------------
    match /users/{uid} {
      allow get, list, write: if (isUserSignedIn() && request.auth.uid == uid) || isAdmin();
    }

    // ---------------------------
    // CHURCHES COLLECTION
    // ---------------------------
    match /churches/{churchId} {

      // MEMBERS
      match /members/{memberId} {
        allow read: if isChurchMember(churchId);
        allow create, update, delete: if hasChurchRole(churchId, ["Admin", "MemberManager"]);
      }

      // EVENTS
      match /events/{eventId} {
        allow read: if isChurchMember(churchId);
        allow create, update, delete: if hasChurchRole(churchId, ["Admin", "EventManager"]);
      }

      // CONTRIBUTIONS
      match /contributions/{contributionId} {
        allow read: if isChurchMember(churchId);
        allow create, update, delete: if hasChurchRole(churchId, ["Admin", "Finance"]);
      }

      // SERVICE PLANS  ‚Üê NEW
      match /servicePlans/{planId} {
        allow read, write: if isChurchMember(churchId);
      }
    }
  }
}
