rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------------------------
    // HELPERS
    // ---------------------------
    function isUserSignedIn() {
      return request.auth != null;
    }

    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isRootAdmin() {
      let userDoc = getUserDoc();
      return isUserSignedIn() &&
             userDoc.data != null &&
             'roles' in userDoc.data &&
             userDoc.data.roles.hasAny(['RootAdmin']);
    }

    function isChurchMember(churchId) {
      let userDoc = getUserDoc();
      return isUserSignedIn() &&
             userDoc.data != null &&
             'churchId' in userDoc.data &&
             userDoc.data.churchId == churchId;
    }

    function hasChurchRole(churchId, allowedRoles) {
      let userDoc = getUserDoc();
      return isChurchMember(churchId) &&
             userDoc.data != null &&
             'roles' in userDoc.data &&
             userDoc.data.roles.hasAny(allowedRoles);
    }

    // ---------------------------
    // USERS
    // ---------------------------
    match /users/{uid} {

      // User can read/write their own document
      allow read, write: if request.auth != null && request.auth.uid == uid;

      // Root Admin full access
      allow read, write: if isRootAdmin();

      // Church Admins can READ users in their church
      allow read: if isUserSignedIn() &&
                  hasChurchRole(resource.data.churchId, ["Admin"]);

      // Church Admins can WRITE users in their church
      allow write: if isUserSignedIn() &&
                   (
                     // Updating existing user
                     (resource.data != null &&
                      hasChurchRole(resource.data.churchId, ["Admin"])) ||

                     // Creating new user
                     (request.resource.data != null &&
                      hasChurchRole(request.resource.data.churchId, ["Admin"]))
                   );
    }

    // ---------------------------
    // CHURCHES ROOT
    // ---------------------------
    match /churches {
      allow list: if isRootAdmin();
    }

    // ---------------------------
    // CHURCHES/{churchId}
    // ---------------------------
    match /churches/{churchId} {

      // 1. Allow login-time read of the user's own church
      allow read: if request.auth != null
            && exists(/databases/$(database)/documents/users/$(request.auth.uid))
            && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.churchId == churchId;

      // 2. Root Admin full access
      allow read, write, list: if isRootAdmin();

      // 3. Members can read their own church
      allow read: if isChurchMember(churchId);

      // 4. Admins can update their church
      allow update: if hasChurchRole(churchId, ["Admin"]);

      // ---------------------------
      // SUBCOLLECTIONS
      // ---------------------------
      match /{sub=**} {
        allow read, write: if isRootAdmin();
        allow read: if isChurchMember(churchId);
        allow write: if hasChurchRole(churchId, ["Admin"]);
      }
    }

    // ---------------------------
    // ROOT ADMIN GLOBAL FALLBACK
    // ---------------------------
    match /{document=**} {
      allow read, write: if isRootAdmin();
    }
  }
}
